# Story 1.4: Basic Idea Submission API

## Status

Draft

## Story

**As a** user, **I want** to submit my business idea through the API, **so
that** it can be evaluated by the system.

## Acceptance Criteria

1. POST /api/ideas endpoint accepting text descriptions
2. Input validation (50-5000 characters)
3. Business idea saved to database with user association
4. Response includes idea ID and initial status
5. Rate limiting implemented (10 requests/minute for free tier)
6. Input sanitization to prevent XSS/injection

## Tasks / Subtasks

- [ ] **Task 1: Business Idea Routes Setup** (AC: 1, 5)
  - [ ] Create `packages/api/src/routes/ideas.ts` with POST /api/ideas endpoint
  - [ ] Implement rate limiting (10 requests/minute) using express-rate-limit
        pattern from auth routes
  - [ ] Add authentication middleware to require user login
  - [ ] Integrate with existing Express app in `packages/api/src/app.ts`
  - [ ] Follow established error handling and response format patterns

- [ ] **Task 2: Input Validation and Sanitization** (AC: 2, 6)
  - [ ] Create validation rules using express-validator for title and
        description fields
  - [ ] Implement 50-5000 character validation for description field
  - [ ] Add title validation (required, 5-100 characters, trimmed)
  - [ ] Add HTML sanitization to prevent XSS attacks using established patterns
  - [ ] Validate content for inappropriate language or spam patterns
  - [ ] Add comprehensive error messages following auth route patterns

- [ ] **Task 3: Business Idea Service Layer** (AC: 3, 4)
  - [ ] Create `packages/api/src/services/businessIdeaService.ts` for business
        logic
  - [ ] Implement idea creation logic with user association
  - [ ] Add title generation from description if title not provided
  - [ ] Set initial status to "submitted" (ready for evaluation)
  - [ ] Add input normalization and preprocessing
  - [ ] Include comprehensive error handling and logging

- [ ] **Task 4: Database Integration** (AC: 3)
  - [ ] Utilize existing BusinessIdea repository pattern from Story 1.2
  - [ ] Create business idea record with user_id from authentication context
  - [ ] Store sanitized title and description in database
  - [ ] Set appropriate status field based on submission type
  - [ ] Add transaction handling for data consistency
  - [ ] Include database error handling and retry logic

- [ ] **Task 5: API Response Format** (AC: 4)
  - [ ] Return standardized response with idea ID, status, and metadata
  - [ ] Include created timestamp and user association confirmation
  - [ ] Add API endpoint metadata (submission limits, next steps)
  - [ ] Follow established response format from existing controllers
  - [ ] Include appropriate HTTP status codes and headers
  - [ ] Add response headers for rate limiting information

- [ ] **Task 6: Frontend Integration Preparation**
  - [ ] Update `packages/web/src/services/api.ts` with ideas endpoint
  - [ ] Create TypeScript types in `packages/shared/src/types/` for BusinessIdea
  - [ ] Add ideas API client methods to frontend service layer
  - [ ] Create composable for idea submission with validation
  - [ ] Add frontend error handling for validation and rate limiting
  - [ ] Prepare reactive stores for idea management

- [ ] **Task 7: Comprehensive Testing** (AC: All)
  - [ ] Write unit tests for business idea service logic
  - [ ] Create integration tests for POST /api/ideas endpoint
  - [ ] Add validation testing for all input scenarios
  - [ ] Test rate limiting with concurrent requests
  - [ ] Add security tests for XSS prevention and input sanitization
  - [ ] Test authentication integration and user association
  - [ ] Create performance tests for database operations

## Dev Notes

### Previous Story Insights

**Source: Story 1.3 Completion Notes**

- Authentication middleware (`authMiddleware.ts`) is fully implemented and
  tested
- Rate limiting patterns established with express-rate-limit (15-min windows,
  configurable limits)
- Validation patterns using express-validator with comprehensive error handling
- Response format standardized with error, code, and details structure
- Repository pattern confirmed working with UserRepository as reference
- JWT token extraction and user context injection working properly

### Data Models

**Source: Story 1.2 Database Implementation + Prisma Schema**

- BusinessIdea model exists with fields: `id` (uuid), `user_id`, `title`,
  `description`, `status`, `created_at`, `updated_at`
  `[Source: packages/api/prisma/schema.prisma]`
- Status field defaults to "draft" with states: draft, submitted, evaluating,
  completed `[Source: packages/api/prisma/schema.prisma]`
- Description field is String type supporting 50-5000 characters per FR1
  requirement `[Source: packages/api/prisma/schema.prisma]`
- Foreign key relationship to User model with CASCADE delete
  `[Source: packages/api/prisma/schema.prisma]`
- Indexes configured on user_id, status, and created_at for query performance
  `[Source: packages/api/prisma/schema.prisma]`
- BusinessIdea repository pattern ready to be implemented following
  UserRepository example `[Source: Story 1.2 completion]`

### API Specifications

**Source: Epic 1.4 Requirements + Technical Assumptions**

- **Endpoint**: POST /api/ideas accepting JSON with title and description
  `[Source: epic-1-foundation.md#Story 1.4]`
- **Validation**: Description 50-5000 characters, title optional but recommended
  `[Source: epic-1-foundation.md#Story 1.4]`
- **Rate Limiting**: 10 requests/minute for free tier users
  `[Source: epic-1-foundation.md#Story 1.4]`
- **Authentication**: Protected endpoint requiring valid JWT token
  `[Source: epic-1-foundation.md#Story 1.4 Dependencies]`
- **Response Format**: Include idea ID, status, and submission metadata
  `[Source: epic-1-foundation.md#Story 1.4]`
- **Input Sanitization**: XSS prevention and injection protection required
  `[Source: epic-1-foundation.md#Story 1.4]`

### Component Specifications

**Source: Established Patterns from Auth Routes and Controllers**

- **Route Structure**: Follow `packages/api/src/routes/auth.ts` pattern with
  rate limiting and validation `[Source: packages/api/src/routes/auth.ts]`
- **Validation Rules**: Use express-validator with body() validation like
  registration endpoint
  `[Source: packages/api/src/routes/auth.ts#registrationValidation]`
- **Rate Limiting**: Express-rate-limit with windowMs, max, and structured error
  messages `[Source: packages/api/src/routes/auth.ts#registrationLimiter]`
- **Error Handling**: Consistent error response format with error, code, details
  structure
  `[Source: packages/api/src/routes/auth.ts#validation error handling]`
- **Service Layer**: Business logic in separate service file following
  authService pattern
  `[Source: packages/api/src/services/authService.ts pattern]`

### File Locations

**Source: Project Structure and Established Patterns**

- **API Routes**: `packages/api/src/routes/ideas.ts` for business idea endpoints
  `[Source: technical-assumptions.md#Monorepo Organization]`
- **Service Layer**: `packages/api/src/services/businessIdeaService.ts` for
  business logic `[Source: technical-assumptions.md#Monorepo Organization]`
- **Repository**: Use existing
  `packages/api/src/repositories/business-idea-repository.ts` from Story 1.2
  `[Source: Story 1.2 completion]`
- **Types**: `packages/shared/src/types/businessIdea.ts` for shared TypeScript
  interfaces `[Source: technical-assumptions.md#Monorepo Organization]`
- **Frontend Service**: `packages/web/src/services/ideas.ts` for API client
  methods `[Source: frontend-architecture.md#Project Structure]`
- **Controllers**: Consider `packages/api/src/controllers/ideas.ts` if following
  existing evaluation controller pattern
  `[Source: packages/api/src/controllers/evaluations.ts]`

### Testing Requirements

**Source: Technical Assumptions Testing Strategy**

- **Unit Tests**: >90% coverage for business idea service logic using Vitest
  `[Source: technical-assumptions.md#Testing Strategy Details]`
- **Integration Tests**: POST /api/ideas endpoint with real database connection
  `[Source: technical-assumptions.md#Testing Strategy Details]`
- **Security Tests**: XSS prevention, input sanitization, rate limiting
  validation `[Source: technical-assumptions.md#Testing Strategy Details]`
- **Authentication Tests**: JWT token requirement and user association
  verification `[Source: Story 1.3 patterns]`
- **Performance Tests**: Database operation performance and concurrent request
  handling `[Source: technical-assumptions.md#Testing Strategy Details]`

### Technical Constraints

**Source: Architecture Documents and Previous Story Patterns**

- **Database Integration**: Must use Prisma ORM and BusinessIdea model from
  Story 1.2 `[Source: Story 1.2 completion]`
- **Authentication**: Must use JWT middleware from Story 1.3 for user
  identification `[Source: Story 1.3 completion]`
- **Rate Limiting**: Follow express-rate-limit patterns from auth routes
  `[Source: packages/api/src/routes/auth.ts patterns]`
- **Validation**: Use express-validator library with established error handling
  patterns `[Source: packages/api/src/routes/auth.ts patterns]`
- **Error Handling**: Follow established error response format with structured
  logging `[Source: technical-assumptions.md#Error Recovery]`
- **TypeScript**: Full TypeScript implementation with strict type checking
  `[Source: technical-assumptions.md#Technology Stack Details]`

### Security Considerations

**Source: Technical Assumptions Security Architecture + Epic Requirements**

- **Input Sanitization**: HTML sanitization and XSS prevention for
  user-generated content `[Source: epic-1-foundation.md#Story 1.4 AC6]`
- **Content Validation**: Check for inappropriate content, spam patterns,
  excessive length `[Source: technical-assumptions.md#Input Validation]`
- **Rate Limiting**: 10 requests/minute per user to prevent abuse
  `[Source: epic-1-foundation.md#Story 1.4 AC5]`
- **Authentication Required**: JWT token validation for all idea submission
  endpoints `[Source: epic-1-foundation.md#Story 1.4 Dependencies]`
- **Data Validation**: Server-side validation regardless of frontend validation
  `[Source: technical-assumptions.md#Application Security]`
- **Audit Logging**: Log all idea submissions for security monitoring
  `[Source: technical-assumptions.md#Observability Stack]`

### Integration Points

**Source: Current Codebase Analysis**

- **Existing Evaluation System**: Current evaluation controller uses in-memory
  storage with TODO for database integration
  `[Source: packages/api/src/controllers/evaluations.ts]`
- **Business Idea to Evaluation Flow**: Story 1.4 creates business ideas that
  Story 1.5 will evaluate
  `[Source: epic-1-foundation.md#Story 1.5 Dependencies]`
- **Response Format Alignment**: Consider aligning with existing controller
  response format `{ success, data/error }`
  `[Source: packages/api/src/controllers/evaluations.ts]`
- **Future Orchestration**: Business ideas will trigger evaluation requests in
  Story 1.5 `[Source: epic-1-foundation.md#Story 1.5]`

## Testing

### Testing Standards

**Source: Technical Assumptions Testing Strategy + Established Patterns**

- **Test File Locations**:
  - Backend tests: `packages/api/tests/unit/business-idea-service.test.ts` and
    `packages/api/tests/integration/ideas-endpoint.test.ts`
  - Frontend tests: `packages/web/tests/unit/ideas.test.ts` for composables and
    services
- **Testing Frameworks**:
  - Backend: Vitest for unit tests, Supertest for API integration tests
  - Frontend: Vitest + Vue Test Utils for unit tests
- **Coverage Requirements**: >90% coverage for business idea service logic and
  validation
- **Security Testing**: XSS prevention, input sanitization, rate limiting
  validation
- **Integration Testing**: Database operations, authentication integration,
  error scenarios
- **Performance Testing**: Concurrent request handling, database operation
  performance

## Change Log

| Date           | Version | Description                                                 | Author         |
| -------------- | ------- | ----------------------------------------------------------- | -------------- |
| [Current Date] | 1.0     | Initial story creation with comprehensive technical context | Bob (SM Agent) |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_This section will be populated by the QA Agent after story completion_
